<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sifood Titip Beli, Ojek & Kurir</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap');

        :root {
            --primary-color: #ff7043;
            --primary-hover-color: #e65a2f;
            --secondary-color: #3498db;
            --accent-color: #2ecc71;
            --light-gray: #f4f6f8;
            --dark-gray: #95a5a6;
            --bg-color: #ffffff;
            --text-color: #34495e;
            --error-color: #e74c3c;
            --border-color: #dfe4ea;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background-color: var(--light-gray);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            align-items: flex-start;
            min-height: 100vh;
            padding: 15px;
            font-size: 16px;
        }

        .container {
            width: 100%;
            max-width: 480px;
            background-color: var(--bg-color);
            border-radius: 16px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            position: relative;
        }
        
        /* Slider CSS Start */
        .slider-container {
            width: 100%;
            aspect-ratio: 16 / 9;
            position: relative;
            overflow: hidden;
            background-color: var(--light-gray);
            cursor: grab; /* Menandakan area bisa digeser */
        }
        
        .slider-container:active {
            cursor: grabbing;
        }

        .slider-wrapper {
            display: flex;
            height: 100%;
            transition: transform 0.5s ease-in-out;
        }

        .slide {
            flex: 0 0 100%;
            width: 100%;
            height: 100%;
        }

        .slide img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            user-select: none; /* Mencegah gambar terseleksi saat digeser */
            pointer-events: none; /* Mencegah event lain pada gambar */
        }
        /* Slider CSS End */
        
        main {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 18px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 0.95rem;
        }

        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.95rem;
            font-family: 'Poppins', sans-serif;
            transition: border-color 0.3s, box-shadow 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.15);
        }

        textarea.form-control {
            resize: vertical;
            min-height: 80px;
        }

        .service-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }

        .service-btn {
            padding: 12px 5px;
            border-radius: 8px;
            border: 2px solid var(--border-color);
            background-color: #fff;
            font-weight: 600;
            font-size: 0.95rem;
            cursor: pointer;
            transition: all 0.3s;
            color: var(--primary-color);
        }

        .service-btn.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color);
            box-shadow: 0 4px 12px rgba(255, 112, 67, 0.3);
        }

        .choice-options {
            display: flex;
            gap: 20px;
            margin-bottom: 15px;
        }

        .choice-options label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            font-size: 0.95rem;
        }
        
        input[type="radio"] {
            accent-color: var(--primary-color);
        }

        .service-specific-options {
            padding: 15px;
            background-color: var(--light-gray);
            border-radius: 8px;
            margin-top: 15px;
        }
        
        #shopping-list-container .shopping-item-row {
            display: grid;
            grid-template-columns: 25px 1fr 70px 70px;
            gap: 8px;
            align-items: center;
            margin-bottom: 8px;
        }
        #shopping-list-container .shopping-item-row span {
            text-align: center;
        }
        
        #shopping-list-container .shopping-item-header {
             font-size: 0.9rem;
             font-weight: 600;
             color: var(--text-color);
             margin-bottom: 10px;
             padding: 0 5px;
        }

        .total-display {
            background-color: var(--light-gray);
            color: var(--primary-color);
            padding: 20px;
            text-align: center;
            border-radius: 8px;
            margin-top: 20px;
        }

        .total-display p {
            font-size: 0.95rem;
            font-weight: 500;
            margin-bottom: 5px;
        }

        .total-display h2 {
            font-size: 2em;
            font-weight: 700;
            letter-spacing: 1px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background-color: var(--primary-color);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            margin-top: 20px;
            transition: background-color 0.3s;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 12px;
        }

        .submit-btn:hover {
            background-color: var(--primary-hover-color);
        }
        
        .submit-btn svg {
            width: 24px;
            height: 24px;
        }

        .hidden {
            display: none !important;
        }

        #history-section {
            padding: 20px;
            background-color: #f9f9f9;
        }

        #history-section h3 {
            text-align: center;
            margin-bottom: 15px;
            color: var(--primary-color);
            font-size: 1.1rem;
        }
        
        #history-list {
            list-style: none;
            padding: 0;
            max-height: 300px;
            overflow-y: auto;
        }
        
        .history-item {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            position: relative;
        }

        .history-item p {
            font-size: 0.95rem;
            margin-bottom: 5px;
            line-height: 1.4;
        }
        
        .history-item p strong {
            color: var(--primary-color);
        }
        
        .history-item .details-block {
            background-color: var(--light-gray);
            border-left: 3px solid var(--secondary-color);
            padding: 10px;
            margin-top: 10px;
            font-size: 1em;
            border-radius: 4px;
        }
        
        .history-item .details-block ul {
            padding-left: 15px;
            margin: 0;
        }

        .history-item .reorder-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: opacity 0.3s;
            position: absolute;
            top: 15px;
            right: 15px;
        }
        .history-item .reorder-btn:hover {
            opacity: 0.85;
        }
        
        #clear-history-btn {
            display: block;
            margin: 15px auto 0;
            background: var(--error-color);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 0.95rem;
            cursor: pointer;
        }
        
        .toast-notification {
            position: fixed;
            top: 25vh;
            left: 50%;
            transform: translate(-50%, -50%); 
            padding: 14px 22px;
            border-radius: 10px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            text-align: center;
            animation: fade-in-down 0.5s ease-out forwards, fade-out-up 0.5s ease-in 2.5s forwards;
        }

        .toast-notification.error { background-color: var(--error-color); }
        .toast-notification.success { background-color: var(--accent-color); }

        @keyframes fade-in-down {
            from { opacity: 0; transform: translate(-50%, -100%); }
            to { opacity: 1; transform: translate(-50%, -50%); }
        }
        @keyframes fade-out-up {
            from { opacity: 1; transform: translate(-50%, -50%); }
            to { opacity: 0; transform: translate(-50%, -100%); }
        }
    </style>
</head>
<body>

    <div class="container">
        <div class="slider-container" id="slider">
            <div class="slider-wrapper">
                <div class="slide"><img src="https://i.ibb.co.com/dJLmZGhp/IMG-20250508-230725-5-11zon.jpg" alt="Slider Image 1"></div>
                <div class="slide"><img src="https://i.ibb.co.com/bgTQ546y/IMG-20250508-232846-1-11zon.jpg" alt="Slider Image 2"></div>
                <div class="slide"><img src="https://i.ibb.co.com/mVG9k98W/IMG-20250508-230752-4-11zon.jpg" alt="Slider Image 3"></div>
                <div class="slide"><img src="https://i.ibb.co.com/ZR6VbPM7/IMG-20250508-230825-3-11zon.jpg" alt="Slider Image 4"></div>
                <div class="slide"><img src="https://i.ibb.co.com/bgTQ546y/IMG-20250508-232846-1-11zon.jpg" alt="Slider Image 5"></div>
            </div>
            </div>


        <main id="order-form">
            <div class="form-group">
                <label>Pilih Layanan</label>
                <div class="service-grid">
                    <button class="service-btn" data-service="Titip Beli">🛒 Titip Beli</button>
                    <button class="service-btn" data-service="Kirim Barang">📦 Kirim Barang</button>
                    <button class="service-btn" data-service="Ojek">🛵 Ojek</button>
                </div>
            </div>

            <div class="form-group">
                <label for="pickup-location" id="pickup-label">Lokasi Jemput</label>
                <select id="pickup-location" class="form-control" required>
                    <option value="">-- 📍 Pilih Lokasi --</option>
                    <option value="0">Kilometer-0</option>
                    <option value="1">Kilometer-1</option>
                    <option value="2">Kilometer-2</option>
                    <option value="3">Kilometer-3</option>
                    <option value="4">Kilometer-4</option>
                    <option value="5">Kilometer-5</option>
                    <option value="6">Kilometer-6</option>
                    <option value="7">Kilometer-7</option>
                    <option value="9">Kilometer-9</option>
                    <option value="10">Kilometer-10</option>
                    <option value="6">(Other) SP2 Desa Sido Makmur</option>
                    <option value="4">(Other) Mapaddegat Bawah</option>
                    <option value="10">(Other) SP3 Bukit Pamewa</option>
                    <option value="20">(Other) Desa Goisooinan</option>
                    <option value="35">(Other) Desa Pogari</option>
                    <option value="42">(Other) Bandara Rokot</option>
                </select>
            </div>
            <div class="form-group">
                <input type="text" id="pickup-detail" class="form-control" placeholder="Detai Lokasi Jemput, Cth: Pelabuhan Kapal Mentawai fast" required>
            </div>

            <div class="form-group">
                <label for="dropoff-location">Lokasi Antar</label>
                <select id="dropoff-location" class="form-control" required>
                    <option value="">-- 📍 Pilih Lokasi Antar --</option>
                    <option value="0">Kilometer-0</option>
                    <option value="1">Kilometer-1</option>
                    <option value="2">Kilometer-2</option>
                    <option value="3">Kilometer-3</option>
                    <option value="4">Kilometer-4</option>
                    <option value="5">Kilometer-5</option>
                    <option value="6">Kilometer-6</option>
                    <option value="7">Kilometer-7</option>
                    <option value="9">Kilometer-9</option>
                    <option value="10">Kilometer-10</option>
                    <option value="6">(Other) SP2 Desa Sido Makmur</option>
                    <option value="4">(Other) Mapaddegat Bawah</option>
                    <option value="10">(Other) SP3 Bukit Pamewa</option>
                    <option value="20">(Other) Desa Goisooinan</option>
                    <option value="35">(Other) Desa Pogari</option>
                    <option value="42">(Other) Bandara Rokot</option>
                </select>
            </div>
            <div class="form-group">
                <input type="text" id="dropoff-detail" class="form-control" placeholder="Detail Lokasi Antar,  Cth: gang beringin no 5" required>
            </div>

            <div class="form-group">
                <div class="choice-options">
                    <label><input type="radio" name="schedule-type" value="sekarang" checked> Untuk Sekarang</label>
                    <label><input type="radio" name="schedule-type" value="nanti"> Untuk Nanti</label>
                </div>
            </div>
            <div id="schedule-section" class="form-group hidden">
                <label for="schedule-datetime">Pilih Tanggal & Jam Pengantaran</label>
                <input type="datetime-local" id="schedule-datetime" class="form-control">
            </div>

            <div id="titip-beli-options" class="service-specific-options hidden">
                <div class="form-group">
                    <div id="shopping-list-container">
                        <div class="shopping-item-row shopping-item-header">
                            <span>No.</span>
                            <span>Nama Barang</span>
                            <span>Jumlah</span>
                            <span>Satuan</span>
                        </div>
                        <div class="shopping-item-row">
                             <span>1.</span>
                             <input type="text" class="form-control shopping-item-name" placeholder="Telur">
                             <input type="number" class="form-control shopping-item-qty" placeholder="10">
                             <input type="text" class="form-control shopping-item-unit" placeholder="butir">
                        </div>
                    </div>
                </div>
                <div id="shopping-cost-section" class="form-group">
                    <input type="number" id="shopping-cost" class="form-control" placeholder="Perkiraan total Belanjaan cth: 50000" required>
                </div>
            </div>

            <div id="kirim-barang-options" class="service-specific-options hidden">
                <div class="form-group">
                    
                     <input type="text" id="item-info" class="form-control" placeholder="Info Barang, Cth: Dus, Baju, Kunci" required>
                </div>
                <div class="form-group">
               
                    <div class="choice-options">
                        <label><input type="radio" name="shipping-payer" value="Pengirim" required checked> Ongkir dibayar Pengirim</label>
                        <label><input type="radio" name="shipping-payer" value="Penerima"> ongkir dibayar Penerima</label>
                    </div>
                </div>
                <div class="form-group">
                    <div class="choice-options">
                        <label><input type="radio" name="cod-status" value="Sudah Lunas" required checked> Barang Sudah Lunas</label>
                        <label><input type="radio" name="cod-status" value="Belum Lunas (COD)"> Barang Belum Lunas (COD)</label>
                    </div>
                </div>
                <div id="cod-cost-section" class="form-group hidden">
                
                    <input type="number" id="cod-cost" class="form-control" placeholder="Harga Barang, cth: 150000">
                </div>
            </div>
            
            <div id="ojek-options" class="service-specific-options hidden">
                 <div class="form-group">
              
                     <textarea id="ojek-notes" class="form-control" placeholder="Catatan, Cth: Mohon tunggu di depan gerbang, pakai helm" required></textarea>
                </div>
            </div>

            <div class="total-display">
                <p>Total Biaya</p>
                <h2 id="total-cost">Rp 0</h2>
            </div>

            <button id="submit-order" class="submit-btn">
                <svg viewBox="0 0 24 24" fill="white" xmlns="http://www.w3.org/2000/svg"><path d="M16.75 13.96c.25.13.41.2.46.3.06.11.04.61-.21 1.18-.2.56-1.24 1.1-1.72 1.18-.49.07-1.12.04-1.68-.16-1.34-.48-2.53-1.42-3.4-2.8-.75-1.21-1.11-2.02-1.23-2.67-.12-.65.2-1.02.51-1.33.2-.21.42-.26.58-.26.16 0 .33.01.46.03.17.02.26.04.44.57.2.53.33 1.11.36 1.18.04.07.03.2-.02.32-.05.12-.13.21-.24.33-.11.12-.24.26-.38.4-.13.14-.27.3-.14.54.13.24.59.93 1.28 1.55.88.78 1.55 1.01 1.81 1.1.1.03.2.02.28-.02.08-.04.28-.33.39-.45.11-.11.23-.21.37-.16.14.05.86.41 1.02.49.16.08.27.13.31.2zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8z"/></svg>
                <span>Kirim Orderan ke WhatsApp Admin</span>
            </button>
        </main>
        
        <section id="history-section">
            <h3>Riwayat Pesanan</h3>
            <ul id="history-list"></ul>
            <button id="clear-history-btn" class="hidden">Hapus Riwayat</button>
        </section>

    </div>

    <script>
    document.addEventListener('DOMContentLoaded', () => {
        // Slider Logic Start
        const slider = document.getElementById('slider');
        const sliderWrapper = slider.querySelector('.slider-wrapper');
        const slides = slider.querySelectorAll('.slide');
        
        let currentIndex = 0;
        let slideInterval;
        let touchStartX = 0;
        let touchEndX = 0;
        const totalSlides = slides.length;

        const goToSlide = (index) => {
            sliderWrapper.style.transform = `translateX(-${index * 100}%)`;
        };

        const nextSlide = () => {
            currentIndex = (currentIndex + 1) % totalSlides;
            goToSlide(currentIndex);
        };

        const prevSlide = () => {
            currentIndex = (currentIndex - 1 + totalSlides) % totalSlides;
            goToSlide(currentIndex);
        };
        
        const startAutoSlide = () => {
            // Reset interval sebelumnya untuk mencegah beberapa interval berjalan bersamaan
            clearInterval(slideInterval);
            slideInterval = setInterval(nextSlide, 2000); // Ganti gambar setiap 2 detik
        };

        const stopAutoSlide = () => {
            clearInterval(slideInterval);
        };
        
        // Event listener untuk swipe/geser
        slider.addEventListener('touchstart', e => {
            touchStartX = e.changedTouches[0].screenX;
            stopAutoSlide(); // Hentikan slide otomatis saat pengguna mulai menyentuh
        });
        
        slider.addEventListener('touchend', e => {
            touchEndX = e.changedTouches[0].screenX;
            handleSwipe();
            startAutoSlide(); // Mulai kembali slide otomatis setelah pengguna selesai menggeser
        });
        
        const handleSwipe = () => {
            // Tentukan ambang batas geser untuk mencegah pergantian slide yang tidak disengaja
            const swipeThreshold = 50; 
            if (touchStartX - touchEndX > swipeThreshold) {
                // Geser ke kiri (Next)
                nextSlide();
            } else if (touchEndX - touchStartX > swipeThreshold) {
                // Geser ke kanan (Prev)
                prevSlide();
            }
        };

        startAutoSlide(); // Mulai slider otomatis saat halaman dimuat
        // Slider Logic End


        const serviceBtns = document.querySelectorAll('.service-btn');
        const pickupLabel = document.getElementById('pickup-label');
        const pickupLocationEl = document.getElementById('pickup-location');
        const pickupDetailEl = document.getElementById('pickup-detail');
        const dropoffLocationEl = document.getElementById('dropoff-location');
        const dropoffDetailEl = document.getElementById('dropoff-detail');
        const scheduleTypeRadios = document.querySelectorAll('input[name="schedule-type"]');
        const scheduleSection = document.getElementById('schedule-section');
        const scheduleDateTimeEl = document.getElementById('schedule-datetime');
        const totalCostEl = document.getElementById('total-cost');
        const submitBtn = document.getElementById('submit-order');
        const historyListEl = document.getElementById('history-list');
        const clearHistoryBtn = document.getElementById('clear-history-btn');

        const titipBeliOptions = document.getElementById('titip-beli-options');
        const shoppingListContainer = document.getElementById('shopping-list-container');
        const shoppingCostEl = document.getElementById('shopping-cost');

        const kirimBarangOptions = document.getElementById('kirim-barang-options');
        const itemInfoEl = document.getElementById('item-info');
        const codStatusRadios = document.querySelectorAll('input[name="cod-status"]');
        const codCostSection = document.getElementById('cod-cost-section');
        const codCostEl = document.getElementById('cod-cost');
        const shippingPayerRadios = document.querySelectorAll('input[name="shipping-payer"]');

        const ojekOptions = document.getElementById('ojek-options');
        const ojekNotesEl = document.getElementById('ojek-notes');
        
        let selectedService = '';
        const ADMIN_PHONE_NUMBER = '6285266610522'; 

        function showToast(message, type = 'error') {
            const existingToast = document.querySelector('.toast-notification');
            if (existingToast) existingToast.remove();
            const toast = document.createElement('div');
            toast.textContent = message;
            toast.className = `toast-notification ${type}`;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }
        
        function calculateFare() {
            const pickupKm = parseFloat(pickupLocationEl.value);
            const dropoffKm = parseFloat(dropoffLocationEl.value);
            if (isNaN(pickupKm) || isNaN(dropoffKm) || !selectedService) return 0;

            const distance = Math.abs(pickupKm - dropoffKm);
            let baseFare = 0, costPerKm = 1500, baseDistance = 2;
            switch (selectedService) {
                case 'Titip Beli': baseFare = 6000; break;
                case 'Kirim Barang': baseFare = 5000; break;
                case 'Ojek': baseFare = 7000; break;
            }
            let deliveryFee = (distance <= baseDistance) ? baseFare : baseFare + (distance - baseDistance) * costPerKm;
            const pickupIsOther = pickupLocationEl.options[pickupLocationEl.selectedIndex]?.text.includes('(Other)');
            const dropoffIsOther = dropoffLocationEl.options[dropoffLocationEl.selectedIndex]?.text.includes('(Other)');
            if (pickupIsOther || dropoffIsOther) deliveryFee += 3000;
            return deliveryFee;
        }
        
        function updateTotal() {
            const deliveryFee = calculateFare();
            let additionalCost = 0;
            if (selectedService === 'Titip Beli') {
                additionalCost = parseFloat(shoppingCostEl.value) || 0;
            } else if (selectedService === 'Kirim Barang' && document.querySelector('input[name="cod-status"]:checked')?.value === 'Belum Lunas (COD)') {
                additionalCost = parseFloat(codCostEl.value) || 0;
            }
            const total = deliveryFee + additionalCost;
            totalCostEl.textContent = formatCurrency(total);
        }

        function formatCurrency(amount) {
            return new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(amount);
        }
        
        function handleServiceSelection(e) {
            serviceBtns.forEach(btn => btn.classList.remove('active'));
            const clickedBtn = e.target.closest('.service-btn');
            clickedBtn.classList.add('active');
            selectedService = clickedBtn.dataset.service;

            titipBeliOptions.classList.add('hidden');
            kirimBarangOptions.classList.add('hidden');
            ojekOptions.classList.add('hidden');
            
            switch (selectedService) {
                case 'Titip Beli':
                    pickupLabel.textContent = 'Lokasi Belanja';
                    pickupDetailEl.placeholder = 'Detail Lokasi Belanja, Cth: Kedai Maskus';
                    titipBeliOptions.classList.remove('hidden');
                    break;
                case 'Kirim Barang':
                    pickupLabel.textContent = 'Lokasi Jemput';
                    pickupDetailEl.placeholder = 'Detai Lokasi jemput, Cth: Depan kantor pos';
                    kirimBarangOptions.classList.remove('hidden');
                    break;
                case 'Ojek':
                    pickupLabel.textContent = 'Lokasi Jemput';
                    pickupDetailEl.placeholder = 'detai lokasi jemput, Cth: Depan Bank Nagari';
                    ojekOptions.classList.remove('hidden');
                    break;
            }
            updateTotal();
        }
        
        function handleCodStatusChange() {
            codCostSection.classList.toggle('hidden', document.querySelector('input[name="cod-status"]:checked').value !== 'Belum Lunas (COD)');
            if(document.querySelector('input[name="cod-status"]:checked').value === 'Sudah Lunas') codCostEl.value = '';
            updateTotal();
        }

        function handleShoppingListInput(e) {
            if (e.target.classList.contains('shopping-item-name')) {
                const currentRow = e.target.closest('.shopping-item-row');
                const allRows = Array.from(shoppingListContainer.querySelectorAll('.shopping-item-row')).filter(row => !row.classList.contains('shopping-item-header'));
                const lastRow = allRows[allRows.length - 1];
                if (currentRow === lastRow && e.target.value.trim() !== '') {
                    addShoppingListItem();
                }
            }
        }
        
        function addShoppingListItem(item = { name: '', qty: '', unit: '' }) {
            const itemCount = shoppingListContainer.querySelectorAll('.shopping-item-row').length;
            const newRow = document.createElement('div');
            newRow.classList.add('shopping-item-row');
            newRow.innerHTML = `
                <span>${itemCount}.</span>
                <input type="text" class="form-control shopping-item-name" placeholder="Nama Barang" value="${item.name}">
                <input type="number" class="form-control shopping-item-qty" placeholder="Jml" value="${item.qty}">
                <input type="text" class="form-control shopping-item-unit" placeholder="Satuan" value="${item.unit}">
            `;
            shoppingListContainer.appendChild(newRow);
        }

        function handleScheduleChange() {
            scheduleSection.classList.toggle('hidden', document.querySelector('input[name="schedule-type"]:checked').value !== 'nanti');
            if(document.querySelector('input[name="schedule-type"]:checked').value === 'nanti') {
                const now = new Date();
                now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
                scheduleDateTimeEl.min = now.toISOString().slice(0, 16);
            }
        }

        function loadHistory() {
            const history = JSON.parse(localStorage.getItem('sifoodOrderHistory')) || [];
            historyListEl.innerHTML = '';
            clearHistoryBtn.classList.toggle('hidden', history.length === 0);

            history.forEach(order => {
                const li = document.createElement('li');
                li.classList.add('history-item');
                li.dataset.orderId = order.id;

                let detailsHtml = '';
                if (order.service === 'Titip Beli') {
                    let shoppingListHtml = '';
                    if (order.shoppingList && order.shoppingList.length > 0) {
                        shoppingListHtml = `<ul>${order.shoppingList.map(item => `<li>${item.qty} ${item.unit} ${item.name}</li>`).join('')}</ul>`;
                    }
                    const shoppingCostInfo = order.shoppingCost > 0 ? `<p><strong>Perkiraan Belanja:</strong> ${formatCurrency(order.shoppingCost)}</p>` : '';
                    detailsHtml = `<div class="details-block">${shoppingListHtml}${shoppingCostInfo}</div>`;
                } else if (order.service === 'Kirim Barang') {
                    const codInfo = order.codCost > 0 ? `<p><strong>Jumlah COD:</strong> ${formatCurrency(order.codCost)}</p>` : '';
                    const shippingPayerInfo = `<p><strong>Ongkir Dibayar:</strong> ${order.shippingPayer}</p>`;
                    detailsHtml = `<div class="details-block"><p><strong>Info Barang:</strong> ${order.itemInfo}</p>${shippingPayerInfo}<p><strong>Status Bayar:</strong> ${order.codStatus}</p>${codInfo}</div>`;
                } else if (order.service === 'Ojek' && order.ojekNotes) {
                    detailsHtml = `<div class="details-block"><p><strong>Catatan:</strong> ${order.ojekNotes}</p></div>`;
                }

                li.innerHTML = `
                    <button class="reorder-btn">Order Ulang</button>
                    <p><strong>Dipesan:</strong> ${order.timestamp}</p>
                    <p><strong>Jadwal:</strong> ${order.scheduleInfo}</p>
                    <p><strong>Layanan:</strong> ${order.service}</p>
                    <p><strong>${order.service === 'Titip Beli' ? 'Belanja' : 'Jemput'}:</strong> ${order.pickupLocation.text} (${order.pickupDetail})</p>
                    <p><strong>Antar:</strong> ${order.dropoffLocation.text} (${order.dropoffDetail})</p>
                    ${detailsHtml}
                `;
                historyListEl.appendChild(li);
            });
        }
        
        function saveOrderToHistory(orderData) {
            let history = JSON.parse(localStorage.getItem('sifoodOrderHistory')) || [];
            const newOrder = { ...orderData, id: new Date().getTime() };
            history.unshift(newOrder); 
            if (history.length > 10) history.pop();
            localStorage.setItem('sifoodOrderHistory', JSON.stringify(history));
            loadHistory();
        }

        function handleHistoryClick(e) {
            if (!e.target.classList.contains('reorder-btn')) return;

            const orderId = e.target.closest('.history-item').dataset.orderId;
            const history = JSON.parse(localStorage.getItem('sifoodOrderHistory')) || [];
            const order = history.find(o => o.id == orderId);

            if (!order) {
                return showToast('Gagal memuat data pesanan lama.', 'error');
            }

            const serviceBtnToClick = document.querySelector(`.service-btn[data-service="${order.service}"]`);
            if (serviceBtnToClick) {
                serviceBtnToClick.click();
            } else {
                return;
            }

            pickupLocationEl.value = order.pickupLocation.value;
            pickupDetailEl.value = order.pickupDetail;
            dropoffLocationEl.value = order.dropoffLocation.value;
            dropoffDetailEl.value = order.dropoffDetail;

            if (order.scheduleType === 'nanti' && order.scheduleDateTime) {
                document.querySelector('input[name="schedule-type"][value="nanti"]').checked = true;
                scheduleDateTimeEl.value = order.scheduleDateTime;
            } else {
                document.querySelector('input[name="schedule-type"][value="sekarang"]').checked = true;
            }
            handleScheduleChange();

            if (order.service === 'Titip Beli') {
                shoppingCostEl.value = order.shoppingCost || '';
                shoppingListContainer.innerHTML = `<div class="shopping-item-row shopping-item-header"><span>No.</span><span>Nama Barang</span><span>Jumlah</span><span>Satuan</span></div>`;
                if (order.shoppingList && order.shoppingList.length > 0) {
                    order.shoppingList.forEach(item => addShoppingListItem(item));
                }
                addShoppingListItem(); 

            } else if (order.service === 'Kirim Barang') {
                itemInfoEl.value = order.itemInfo;
                document.querySelector(`input[name="shipping-payer"][value="${order.shippingPayer}"]`).checked = true;
                document.querySelector(`input[name="cod-status"][value="${order.codStatus}"]`).checked = true;
                
                handleCodStatusChange();
                if (order.codStatus === 'Belum Lunas (COD)') {
                    codCostEl.value = order.codCost;
                }
            } else if (order.service === 'Ojek') {
                ojekNotesEl.value = order.ojekNotes || '';
            }
            
            updateTotal();

            window.scrollTo({ top: 0, behavior: 'smooth' }); 
            showToast('Data pesanan telah berhasil dimuat ulang.', 'success');
        }

        function clearHistory() {
            if (confirm('Anda yakin ingin menghapus semua riwayat pesanan?')) {
                localStorage.removeItem('sifoodOrderHistory');
                loadHistory();
            }
        }

        function submitOrder() {
            const orderState = {}; 

            if (!selectedService) return showToast('PENTING: Pilih jenis layanan terlebih dahulu!');
            
            const pickupLocText = pickupLocationEl.options[pickupLocationEl.selectedIndex]?.text;
            const dropoffLocText = dropoffLocationEl.options[dropoffLocationEl.selectedIndex]?.text;
            
            if (!pickupLocationEl.value) return showToast(`PENTING: Pilih lokasi ${selectedService === 'Titip Beli' ? 'belanja' : 'jemput'}!`);
            if (!pickupDetailEl.value.trim()) return showToast(`PENTING: Isi detail lokasi ${selectedService === 'Titip Beli' ? 'belanja' : 'jemput'}! (Contoh: Nama Toko/Patokan)`);
            if (!dropoffLocationEl.value) return showToast('PENTING: Pilih lokasi antar!');
            if (!dropoffDetailEl.value.trim()) return showToast('PENTING: Isi detail lokasi antar! (Contoh: Nama Jalan/Nomor Rumah)');
            
            const scheduleType = document.querySelector('input[name="schedule-type"]:checked').value;
            if (scheduleType === 'nanti' && !scheduleDateTimeEl.value) return showToast('PENTING: Pilih tanggal dan jam pengantaran untuk pesanan terjadwal!');

            orderState.service = selectedService;
            orderState.timestamp = new Date().toLocaleString('id-ID', { dateStyle: 'long', timeStyle: 'short' }).replace(/\./g, ':');
            orderState.scheduleInfo = (scheduleType === 'nanti')
                ? new Date(scheduleDateTimeEl.value).toLocaleString('id-ID', { weekday: 'long', day: 'numeric', month: 'long', hour: '2-digit', minute: '2-digit' }).replace(/\./g, ':')
                : 'Sekarang';
            orderState.pickupLocation = { value: pickupLocationEl.value, text: pickupLocText };
            orderState.pickupDetail = pickupDetailEl.value.trim();
            orderState.dropoffLocation = { value: dropoffLocationEl.value, text: dropoffLocText };
            orderState.dropoffDetail = dropoffDetailEl.value.trim();
            
            orderState.scheduleType = scheduleType;
            if (scheduleType === 'nanti') {
                orderState.scheduleDateTime = scheduleDateTimeEl.value;
            }
            
            let totalCostForMessage = calculateFare();
            let additionalDetails = '';

            switch (selectedService) {
                case 'Titip Beli':
                    const shoppingItems = [];
                    const rows = shoppingListContainer.querySelectorAll('.shopping-item-row');
                    for (let i = 1; i < rows.length; i++) {
                        const row = rows[i];
                        const nameEl = row.querySelector('.shopping-item-name');
                        const qtyEl = row.querySelector('.shopping-item-qty');
                        const unitEl = row.querySelector('.shopping-item-unit');
                        
                        const name = nameEl.value.trim();
                        const qty = qtyEl.value.trim();
                        const unit = unitEl.value.trim();
                        
                        if (name || qty || unit) {
                            if (!name) return showToast(`Lengkapi Belanjaan: Nama barang di baris ${i} wajib diisi!`);
                            if (!qty) return showToast(`Lengkapi Belanjaan: Jumlah untuk "${name}" wajib diisi!`);
                            if (!unit) return showToast(`Lengkapi Belanjaan: Satuan untuk "${name}" wajib diisi! (cth: pcs, kg, liter)`);
                            shoppingItems.push({ name, qty, unit });
                        }
                    }

                    if (shoppingItems.length === 0) return showToast('PENTING: Daftar belanjaan tidak boleh kosong! Isi minimal satu barang.');
                    
                    const shoppingCost = parseFloat(shoppingCostEl.value) || 0;
                    if (shoppingCost <= 0) return showToast('PENTING: Perkiraan total harga belanja wajib diisi dengan angka yang benar!');
                    
                    orderState.shoppingList = shoppingItems;
                    orderState.shoppingCost = shoppingCost;
                    
                    shoppingItems.forEach(item => { additionalDetails += `- ${item.name} (${item.qty} ${item.unit})\n`; });
                    additionalDetails += `\n*PERKIRAAN BELANJA: ${formatCurrency(shoppingCost)}*\n`;
                    totalCostForMessage += shoppingCost;
                    break;

                case 'Kirim Barang':
                    const itemInfo = itemInfoEl.value.trim();
                    if (!itemInfo) return showToast('PENTING: Informasi barang yang akan dikirim wajib diisi!');
                    orderState.itemInfo = itemInfo;
                    
                    orderState.codStatus = document.querySelector('input[name="cod-status"]:checked').value;
                    orderState.shippingPayer = document.querySelector('input[name="shipping-payer"]:checked').value;

                    additionalDetails += `*Info Barang:* ${orderState.itemInfo}\n`;
                    additionalDetails += `*Ongkir Dibayar Oleh:* ${orderState.shippingPayer}\n`;
                    additionalDetails += `*Status Bayar Barang:* ${orderState.codStatus}\n`;

                    if (orderState.codStatus === 'Belum Lunas (COD)') {
                        const codCost = parseFloat(codCostEl.value) || 0;
                        if (codCost <= 0) return showToast('PENTING: Jumlah COD wajib diisi dengan angka yang benar!');
                        orderState.codCost = codCost;
                        additionalDetails += `*JUMLAH COD: ${formatCurrency(codCost)}*\n`;
                        totalCostForMessage += codCost;
                    } else {
                        orderState.codCost = 0;
                    }
                    break;
                case 'Ojek':
                    const ojekNotes = ojekNotesEl.value.trim();
                    if (!ojekNotes) return showToast('PENTING: Catatan untuk Ojek wajib diisi! (Cth: "Tunggu di depan gerbang", "Pakai helm")');
                    orderState.ojekNotes = ojekNotes;
                    additionalDetails += `*Catatan:* ${orderState.ojekNotes}\n`;
                    break;
            }
            
            let message = `*===== ORDER BARU | SIFOOD =====*\n\n`;
            message += `*LAYANAN :* _${orderState.service}_\n`;
            message += `*WAKTU ORDER :* _${orderState.timestamp}_\n`;
            message += `*JADWAL ANTAR :* _${orderState.scheduleInfo}_\n\n`;
            message += `*------------------------------------*\n\n`;
            message += `*▶️ ${selectedService === 'Titip Beli' ? 'LOKASI BELANJA' : 'JEMPUT DARI'}:*\n`;
            message += `*Lokasi Utama:* ${orderState.pickupLocation.text}\n`;
            message += `*Detail/Patokan:* ${orderState.pickupDetail}\n\n`;
            message += `*▶️ ANTAR KE:*\n`;
            message += `*Lokasi Utama:* ${orderState.dropoffLocation.text}\n`;
            message += `*Detail/Patokan:* ${orderState.dropoffDetail}\n\n`;
            message += `*▶️ DETAIL PESANAN:*\n`;
            message += `${additionalDetails}\n`;
            message += `*------------------------------------*\n\n`;
            message += `*RINCIAN BIAYA*\n`;
            message += `*Ongkos Kirim:* ${formatCurrency(calculateFare())}\n`;
            if (orderState.service === 'Titip Beli') message += `*Perkiraan Belanja:* ${formatCurrency(orderState.shoppingCost)}\n`;
            if (orderState.service === 'Kirim Barang' && orderState.codCost > 0) message += `*Jumlah COD:* ${formatCurrency(orderState.codCost)}\n`;
            message += `*TOTAL ESTIMASI AKHIR: ${formatCurrency(totalCostForMessage)}*\n\n`;
            message += `Terima Kasih telah menggunakan layanan Sifood! Orderan Anda akan segera kami proses. Mohon untuk standby. 🙏`;

            saveOrderToHistory(orderState);
            const whatsappUrl = `https://wa.me/${ADMIN_PHONE_NUMBER}?text=${encodeURIComponent(message)}`;
            window.open(whatsappUrl, '_blank');
        }

        // Event Listeners
        serviceBtns.forEach(btn => btn.addEventListener('click', handleServiceSelection));
        [pickupLocationEl, dropoffLocationEl, shoppingCostEl, codCostEl].forEach(el => el.addEventListener('input', updateTotal));
        codStatusRadios.forEach(radio => radio.addEventListener('change', handleCodStatusChange));
        scheduleTypeRadios.forEach(radio => radio.addEventListener('change', handleScheduleChange));
        shoppingListContainer.addEventListener('input', handleShoppingListInput);
        submitBtn.addEventListener('click', submitOrder);
        historyListEl.addEventListener('click', handleHistoryClick);
        clearHistoryBtn.addEventListener('click', clearHistory);

        // Inisialisasi
        loadHistory();
    });
    </script>
</body>
</html>
